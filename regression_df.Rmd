---
title: "data_regression"
output: html_document
---

```{r}
library(tidyverse)
library(readr)
library(readxl)
```

```{r}
# Import data
main_df <- 
  read_csv("./data/maindata.csv")
```


```{r}
pop_stat <- 
  read_csv("data/census.csv")
```


```{r}
gun_owner <- 
  read_csv("data/Gun Ownership by State 2021.csv") %>% 
  janitor::clean_names() %>% 
  select(-total_guns)
```


```{r}
crime_stat <- 
  read_excel("data/reported-violent-crime-rate-in-the-us-2020-by-state.xlsx", 
             sheet = "Data",
             range = "B5:C57") %>%
  rename(state = 1, crime_per_10e6 = 2) %>% 
  filter(state != "United States") %>% 
  mutate(crime_per_10e6 = as.numeric(crime_per_10e6))
```


```{r}
unempolyment_stat <- 
  read_excel("data/state-unemployment-rate-in-the-us-2020.xlsx", 
             sheet = "Data",
             range = "B5:C56") %>% 
  rename(state = 1, unemploy_rate = 2) %>% 
  mutate(unemploy_rate = as.numeric(unemploy_rate)/100)
```


```{r}
# Join data
pop_gun_crime_unemply <- 
  gun_owner %>% 
  
  left_join(crime_stat, by = "state") %>% 
  left_join(unempolyment_stat, by = "state") %>% 
  mutate(state = state.abb[match(state, state.name)]) %>% 
 
  select(state, everything())
```


```{r}
regression_1 <- 
  main_df %>% 
  separate(date_of_death, into =c("year", "month", "day")) %>% 
  filter(year %in% c(2010:2020)) %>% 
  mutate(year = as.double(year)) %>% 
  right_join(pop_gun_crime_unemply, by = "state") %>% 
  left_join(pop_stat, by = c("state", "year", "gender", "race", "age_bin"))
 

```


```{r}
regression_df <- 
  main_df %>% 
  separate(date_of_death, into =c("year", "month", "day")) %>% 
  group_by(state, year, gender, race, age_bin) %>% 
  summarize(count = n()) %>% 
  select(age_bin, gender, race, state) %>% 
  right_join(pop_gun_crime_unemply, by = "state") %>% 
  group_by(state) %>% 
  summarize(count = n()) %>% 
  drop_na() %>% 
  left_join(regression_1, by = "state") %>% 
  mutate(death_rate = round(count/population*100, digits = 2))
```

```{r}
regression_mod1 <- 
  regression_df %>% 
  select(age_bin, gender, year, race, death_rate, state)

mul.fit = lm(death_rate ~., data = regression_mod1)
step(mul.fit, direction = "both")
```


```{r}
mod1 = lm(formula = death_rate^(-1/3) ~ age_bin + year + race + state, data = regression_mod1)
MASS::boxcox(mod1)
plot(mod1)
```

```{r}
regression_mod2 <- 
  regression_df %>% 
  filter(year == 2020) %>% 
  select(age_bin, gender, race, death_rate, state, gun_ownership, unemploy_rate, crime_per_10e6)

mul.fit2 = lm(death_rate ~., data = regression_mod2)
step(mul.fit2, direction = "both")
```

```{r}
mul.fit2 = lm(death_rate ~., data = regression_mod2)
step(mul.fit2, direction = "forward")
```

```{r}
mod2 = lm(formula = death_rate^(-1/3) ~ age_bin + race + state, data = regression_mod2)
MASS::boxcox(mod2)
plot(mod2)
```
```{r}
mod3 = lm(formula = death_rate^(-1/3) ~ age_bin + gender + race + state + gun_ownership + 
    unemploy_rate + crime_per_10e6, data = regression_mod2)
MASS::boxcox(mod3)
plot(mod3)
```


